<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Tasks - Tahanan ng Pagmamahal OMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'red-primary': '#dc2626',
                        'red-secondary': '#ef4444',
                        'red-light': '#fef2f2'
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Card and Tab Styles from volunteer-tasks.html */
        .task-card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid #f1f5f9;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-progress { background-color: #dbeafe; color: #1e40af; }
        .status-completed { background-color: #f3f4f6; color: #000000; }
        /* Animated underline for tabs */
        .tab-underline {
            transition: all 0.3s cubic-bezier(.4,0,.2,1);
            position: absolute;
            bottom: 0;
            height: 3px;
            background: #dc2626;
            border-radius: 6px 6px 0 0;
        }

        .tab-active {
            color: #dc2626 !important;
            font-weight: 700 !important;
            border-bottom: 3px solid #dc2626;
            background: #fef2f2;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Left Sidebar - Desktop Only -->
    <div id="sidebar" class="hidden lg:block fixed inset-y-0 left-0 z-40 w-64 bg-white shadow-lg">
        <div class="flex flex-col h-screen overflow-y-auto">
            <!-- Logo -->
            <div class="flex items-center justify-center h-20 bg-white shrink-0">
                <img src="tahanan-logo.png" alt="Tahanan ng Pagmamahal Logo" class="w-[90%]">
            </div>
            <!-- Navigation -->
            <nav class="flex-1 mt-8 pb-6">
                <div class="px-4">
                    <ul class="space-y-2">
                        <li>
                            <a href="volunteer-dashboard.html" class="flex items-center px-4 py-3 text-base text-gray-700 hover:bg-red-light hover:text-red-primary rounded-md">
                                <svg class="h-7 w-7 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                </svg>
                                Home
                            </a>
                        </li>
                        <li>
                            <a href="#" class="flex items-center px-4 py-3 text-base text-red-primary bg-red-light rounded-md font-medium">
                                <svg class="h-7 w-7 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                </svg>
                                Tasks
                            </a>
                        </li>
                        <li>
                            <a href="volunteer-announcements.html" class="flex items-center px-4 py-3 text-base text-gray-700 hover:bg-red-light hover:text-red-primary rounded-md">
                                <svg class="h-7 w-7 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
                                </svg>
                                Announcements
                            </a>
                        </li>
                        <li>
                            <a href="volunteer-profile.html" class="flex items-center px-4 py-3 text-base text-gray-700 hover:bg-red-light hover:text-red-primary rounded-md">
                                <svg class="h-7 w-7 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                Profile
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="lg:ml-64 bg-gray-50 min-h-screen">
        <!-- Top Header - Mobile Navigation -->
        <header class="bg-white shadow-sm border-b flex-shrink-0 lg:hidden">
            <div class="flex items-center justify-between px-4 py-4">
                <!-- Logo for Mobile -->
                <div class="flex items-center">
                    <img src="tahanan-logo.png" alt="Tahanan ng Pagmamahal Logo" class="h-10">
                </div>
                <!-- Profile Button -->
                <div class="relative">
                    <button id="profile-btn-mobile" class="flex items-center space-x-2 p-1 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center text-white font-medium text-sm">
                            <span id="userInitialsMobile">V</span>
                        </div>
                    </button>
                </div>
            </div>
        </header>

        <!-- Desktop Header -->
        <header class="bg-white shadow-sm border-b flex-shrink-0 hidden lg:block">
            <div class="flex items-center justify-end px-4 sm:px-6 lg:px-8 py-4">
                <!-- Profile Button -->
                <div class="relative">
                    <button id="profile-btn" class="flex items-center space-x-2 p-1 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center text-white font-medium">
                            <span id="userInitials">V</span>
                        </div>
                    </button>
                    <!-- Profile Dropdown -->
                    <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50 border">
                        <div class="py-1">
                            <div id="profileInfo" class="px-4 py-3 border-b">
                                <p class="text-sm font-medium text-gray-900" id="profileName">Volunteer</p>
                                <p class="text-xs text-gray-500" id="profileRole">Volunteer</p>
                            </div>
                            <a href="volunteer-profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profile Settings</a>
                            <hr class="my-1">
                            <button id="logoutBtn" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- DESIGN REPLACEMENT STARTS HERE -->
        <div class="max-w-3xl mx-auto p-4 sm:p-6 lg:p-8">
            <!-- My Tasks Header -->
            <div class="bg-white border-b border-gray-200 px-4 py-4 rounded-t-lg">
                <h1 class="text-xl font-bold text-center text-black uppercase tracking-wide">MY TASKS</h1>
            </div>
            <!-- Tab Navigation with Animation -->
            <div class="bg-white border-b border-gray-200 relative">
                <div id="tabNav" class="flex relative">
                    <button id="currentTab" class="flex-1 py-3 px-4 text-center font-medium text-gray-600 relative tab-active">
                        Current
                    </button>
                    <button id="completedTab" class="flex-1 py-3 px-4 text-center font-medium text-gray-600 relative">
                        Completed
                    </button>
                    <!-- Animated underline -->
                    <span id="tabUnderline" class="tab-underline absolute left-0 w-1/2"></span>
                </div>
            </div>
            <!-- Tasks Container -->
            <div id="tasksContainer" class="space-y-4 pt-6">
                <!-- Current Tasks View -->
                <div id="currentTasks" class="space-y-3">
                    <div class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-red-600"></div>
                        <p class="mt-2 text-gray-600">Loading tasks...</p>
                    </div>
                </div>
                <!-- Completed Tasks View -->
                <div id="completedTasks" class="space-y-3 hidden">
                    <div class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-red-600"></div>
                        <p class="mt-2 text-gray-600">Loading completed tasks...</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- DESIGN REPLACEMENT ENDS HERE -->
    </div>

    <!-- Bottom Navigation - Mobile Only -->
    <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50">
        <div class="grid grid-cols-4 h-16">
            <!-- Home -->
            <a href="volunteer-dashboard.html" class="flex flex-col items-center justify-center text-gray-600 hover:text-red-primary">
                <svg class="h-5 w-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span class="text-xs font-medium">Home</span>
            </a>
            <a href="#" class="flex flex-col items-center justify-center text-red-primary bg-red-light">
                <svg class="h-5 w-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                </svg>
                <span class="text-xs font-medium">Tasks</span>
            </a>
            <a href="volunteer-announcements.html" class="flex flex-col items-center justify-center text-gray-600 hover:text-red-primary">
                <svg class="h-5 w-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
                </svg>
                <span class="text-xs font-medium">Announcements</span>
            </a>
            <a href="volunteer-profile.html" class="flex flex-col items-center justify-center text-gray-600 hover:text-red-primary">
                <svg class="h-5 w-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                <span class="text-xs font-medium">Profile</span>
            </a>
        </div>
    </nav>

    <script type="module">
import { db, collection, getDocs, updateDoc, doc, addDoc } from './firebase.js';
let currentUser = null;
let currentTab = 'current';
let allTasks = [];

const sessionManager = {
    getCurrentUser: function() {
        const user = localStorage.getItem('currentUser');
        return user ? JSON.parse(user) : null;
    },
    requireLogin: function() {
        const user = this.getCurrentUser();
        if (!user) {
            window.location.href = 'login.html';
            return false;
        }
        if (user.role !== 'volunteer') {
            window.location.href = 'index.html';
            return false;
        }
        return true;
    },
    logout: function() {
        localStorage.removeItem('currentUser');
        window.location.href = 'login.html';
    }
};

document.addEventListener('DOMContentLoaded', function() {
    if (!sessionManager.requireLogin()) return;
    currentUser = sessionManager.getCurrentUser();
    initializePage();
    loadTasksData();
    setupEventListeners();
});

function initializePage() {
    let displayName = '';
    if (currentUser.name) {
        displayName = currentUser.name;
    } else if (currentUser.firstName && currentUser.lastName) {
        displayName = `${currentUser.firstName} ${currentUser.lastName}`;
    } else if (currentUser.firstName) {
        displayName = currentUser.firstName;
    } else {
        displayName = 'Volunteer';
    }
    let initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase() || 'V';
    document.getElementById('userInitials').textContent = initials;
    document.getElementById('userInitialsMobile').textContent = initials;
    document.getElementById('profileName').textContent = displayName;
    document.getElementById('profileRole').textContent = 'Volunteer';
}

function setupEventListeners() {
    const profileBtn = document.getElementById('profile-btn');
    const profileDropdown = document.getElementById('profile-dropdown');
    if (profileBtn && profileDropdown) {
        profileBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            profileDropdown.classList.toggle('hidden');
        });
        document.addEventListener('click', function() {
            profileDropdown.classList.add('hidden');
        });
        profileDropdown.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
            sessionManager.logout();
        });
    }
    const currentTabBtn = document.getElementById('currentTab');
    const completedTabBtn = document.getElementById('completedTab');
    if (currentTabBtn) currentTabBtn.addEventListener('click', () => switchTab('current'));
    if (completedTabBtn) completedTabBtn.addEventListener('click', () => switchTab('completed'));
}

document.addEventListener('DOMContentLoaded', setupEventListeners);

async function loadTasksData() {
    try {
        const taskCol = collection(db, 'tasks');
        const taskSnapshot = await getDocs(taskCol);
        allTasks = [];
        taskSnapshot.forEach(docSnap => {
            const data = docSnap.data();
            allTasks.push({
                taskId: docSnap.id,
                assignedTo: data.assignedTo || "",
                author: data.author || "",
                authorRole: data.authorRole || "",
                createdAt: data.createdAt || "",
                description: data.description || "",
                dueDate: data.dueDate || "",
                peopleNeeded: Number(data.peopleNeeded) || 1,
                priority: data.priority || "",
                status: data.status || "",
                title: data.title || "",
                acceptedBy: Array.isArray(data.acceptedBy) ? data.acceptedBy : [],
                completedBy: Array.isArray(data.completedBy) ? data.completedBy : []
            });
        });
        displayTasks();
    } catch (error) {
        console.error('Error loading tasks:', error);
        document.getElementById('currentTasks').innerHTML = `<div class="text-center py-12"><i class="fas fa-tasks text-4xl text-gray-300 mb-4"></i><h3 class="text-lg font-medium text-gray-900 mb-2">Error loading tasks</h3><p class="text-gray-600">Please try reloading the page.</p></div>`;
        document.getElementById('completedTasks').innerHTML = `<div class="text-center py-12"><i class="fas fa-tasks text-4xl text-gray-300 mb-4"></i><h3 class="text-lg font-medium text-gray-900 mb-2">Error loading completed tasks</h3><p class="text-gray-600">Please try reloading the page.</p></div>`;
    }
}

function displayTasks() {
    let userFullName = currentUser?.name || `${currentUser?.firstName || ""} ${currentUser?.lastName || ""}`.trim();
    let filteredTasks = [];
    const container = document.getElementById(currentTab === 'current' ? 'currentTasks' : 'completedTasks');
    if (currentTab === 'current') {
        filteredTasks = allTasks.filter(task =>
            !task.completedBy?.includes(userFullName) &&
            (!task.acceptedBy || !task.acceptedBy.includes(userFullName) || (task.acceptedBy.includes(userFullName) && !task.completedBy?.includes(userFullName)))
        );
    } else {
        filteredTasks = allTasks.filter(task =>
            task.acceptedBy?.includes(userFullName)
        );
    }
    if (filteredTasks.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12">
                <i class="fas fa-tasks text-4xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No tasks found</h3>
                <p class="text-gray-600">There are currently no tasks in this category.</p>
            </div>
        `;
        return;
    }
    container.innerHTML = filteredTasks.map(task => {
        if (currentTab === 'current') {
            return createTaskCard(task);
        } else {
            return createCompletedTaskCard(task);
        }
    }).join('');
}

function updateTabUnderline() {
    const underline = document.getElementById('tabUnderline');
    if (!underline) return;
    if (currentTab === 'current') {
        underline.style.left = '0';
        underline.style.width = '50%';
    } else {
        underline.style.left = '50%';
        underline.style.width = '50%';
    }
}

function switchTab(tab) {
    currentTab = tab;
    document.getElementById('currentTab').classList.remove('tab-active');
    document.getElementById('completedTab').classList.remove('tab-active');
    if (tab === 'current') {
        document.getElementById('currentTab').classList.add('tab-active');
    } else {
        document.getElementById('completedTab').classList.add('tab-active');
    }
    document.getElementById('currentTasks').classList.toggle('hidden', tab !== 'current');
    document.getElementById('completedTasks').classList.toggle('hidden', tab !== 'completed');
    updateTabUnderline();
    displayTasks();
}

function createTaskCard(task) {
    let isFull = task.acceptedBy.length >= task.peopleNeeded;
    let userFullName = currentUser?.name || `${currentUser?.firstName || ""} ${currentUser?.lastName || ""}`.trim();
    let isAccepted = userFullName && task.acceptedBy.includes(userFullName);

    let statusClass = {
        'pending': 'status-pending',
        'in-progress': 'status-progress',
        'completed': 'status-completed',
        'full': 'status-full'
    }[isFull ? 'full' : task.status] || 'status-pending';
    let statusText = isFull ? 'Full' : ({
        'pending': 'Pending',
        'in-progress': 'In Progress',
        'completed': 'Completed'
    }[task.status] || 'Pending');

    let priorityColor = {
        'high': 'bg-red-100 text-red-800',
        'medium': 'bg-yellow-100 text-yellow-800',
        'low': 'bg-green-100 text-green-800'
    }[task.priority] || 'bg-yellow-100 text-yellow-800';

    let dueDate = 'No due date';
    if (task.dueDate) {
        try {
            dueDate = new Date(task.dueDate).toLocaleDateString();
        } catch (e) {}
    }
    let acceptBtnDisabled = isFull || isAccepted;
    let acceptBtnText = isAccepted ? 'Accepted' : (isFull ? 'Full' : 'Accept Task');
    let acceptBtnClass = acceptBtnDisabled
        ? 'bg-gray-400 text-white px-4 py-2 rounded-md text-sm font-medium cursor-not-allowed'
        : 'bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-red-700 transition-colors';

    return `
        <div class="task-card">
            <div class="flex justify-between items-start mb-3">
                <h3 class="font-bold text-black text-lg">${task.title}</h3>
                <span class="status-badge ${statusClass}">${statusText}</span>
            </div>
            <p class="text-gray-700 text-sm mb-3 leading-relaxed">${task.description || ''}</p>
            <div class="space-y-2 mb-4">
                <div class="flex items-center text-sm text-gray-600">
                    <i class="fas fa-calendar-alt w-4 mr-2"></i>
                    <span>Due: ${dueDate}</span>
                </div>
                <div class="flex items-center text-sm text-gray-600">
                    <i class="fas fa-user w-4 mr-2"></i>
                    <span>Assigned by: ${task.author || 'System'}</span>
                </div>
                <div class="flex items-center text-sm text-gray-600">
                    <i class="fas fa-users w-4 mr-2"></i>
                    <span>${task.acceptedBy.length} / ${task.peopleNeeded} Volunteers Accepted</span>
                </div>
            </div>
            <div class="flex items-center text-sm mb-2">
                <span class="mr-2">Priority:</span>
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${priorityColor}">${task.priority}</span>
            </div>
            <div class="flex justify-end mt-3">
                <button
                    ${acceptBtnDisabled ? 'disabled' : ''}
                    class="${acceptBtnClass}"
                    onclick="window.acceptTask && window.acceptTask('${task.taskId}')"
                >${acceptBtnText}</button>
            </div>
        </div>
    `;
}

function createCompletedTaskCard(task) {
    let userFullName = currentUser?.name || `${currentUser?.firstName || ""} ${currentUser?.lastName || ""}`.trim();
    let isCompleted = Array.isArray(task.completedBy) && task.completedBy.includes(userFullName);
    let priorityColor = {
        'high': 'bg-red-100 text-red-800',
        'medium': 'bg-yellow-100 text-yellow-800',
        'low': 'bg-green-100 text-green-800'
    }[task.priority] || 'bg-yellow-100 text-yellow-800';
    let dueDate = 'No due date';
    if (task.dueDate) {
        try {
            dueDate = new Date(task.dueDate).toLocaleDateString();
        } catch (e) {}
    }
    let statusClass = isCompleted ? 'status-completed' : 'status-progress';
    let statusText = isCompleted ? 'Completed' : 'Accepted';

    return `
        <div class="task-card">
            <div class="flex justify-between items-start mb-3">
                <h3 class="font-bold text-black text-lg">${task.title}</h3>
                <span class="status-badge ${statusClass}">${statusText}</span>
            </div>
            <p class="text-gray-700 text-sm mb-3 leading-relaxed">${task.description || ''}</p>
            <div class="space-y-2 mb-4">
                <div class="flex items-center text-sm text-gray-600">
                    <i class="fas fa-calendar-alt w-4 mr-2"></i>
                    <span>Due: ${dueDate}</span>
                </div>
                <div class="flex items-center text-sm text-gray-600">
                    <i class="fas fa-user w-4 mr-2"></i>
                    <span>Assigned by: ${task.author || 'System'}</span>
                </div>
            </div>
            <div class="flex items-center text-sm mb-2">
                <span class="mr-2">Priority:</span>
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${priorityColor}">${task.priority}</span>
            </div>
            <div class="flex justify-end mt-3" style="min-height:48px;">
                ${
                !isCompleted
                ? `<button id="complete-btn-${task.taskId}" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700 transition-colors" onclick="window.completeTask && window.completeTask('${task.taskId}')">Complete Task</button>
                   <button id="submit-btn-${task.taskId}" class="bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-green-700 transition-colors hidden" onclick="window.submitTask && window.submitTask('${task.taskId}')">Submit</button>`
                : `<button class="bg-gray-400 text-white px-4 py-2 rounded-md text-sm font-medium cursor-not-allowed" disabled>Completed</button>`
                }
            </div>
        </div>
    `;
}

// Accept Task handler (global for button onclick)
window.acceptTask = async function(taskId) {
    const task = allTasks.find(t => t.taskId === taskId);
    if (!task) return;
    let userFullName = currentUser?.name || `${currentUser?.firstName || ""} ${currentUser?.lastName || ""}`.trim();
    if (!userFullName) return;
    if (task.acceptedBy.includes(userFullName) || task.acceptedBy.length >= task.peopleNeeded) return;
    task.acceptedBy.push(userFullName);
    try {
        const taskDocRef = doc(db, 'tasks', taskId);
        await updateDoc(taskDocRef, { acceptedBy: task.acceptedBy });
    } catch (err) {
        alert("Could not accept task. Try again!");
        task.acceptedBy.pop();
    }
    displayTasks();
};

// Complete Task handler
window.completeTask = async function(taskId) {
    const task = allTasks.find(t => t.taskId === taskId);
    if (!task) return;
    let userFullName = currentUser?.name || `${currentUser?.firstName || ""} ${currentUser?.lastName || ""}`.trim();
    if (!userFullName) return;
    if (!task.completedBy.includes(userFullName)) {
        task.completedBy.push(userFullName);
        try {
            const taskDocRef = doc(db, 'tasks', taskId);
            await updateDoc(taskDocRef, { completedBy: task.completedBy });
        } catch (err) {
            alert("Could not mark as completed. Try again!");
            task.completedBy.pop();
            return;
        }
    }
    // Fade out Complete button, show Submit
    const btn = document.getElementById(`complete-btn-${taskId}`);
    const submitBtn = document.getElementById(`submit-btn-${taskId}`);
    if (btn) {
        btn.textContent = "Completed";
        btn.classList.add("fade-out");
        btn.disabled = true;
        setTimeout(() => {
            if (btn) btn.style.display = "none";
            if (submitBtn) submitBtn.classList.remove("hidden");
        }, 1500);
    }
};

// Submit Task handler (announcement)
window.submitTask = async function(taskId) {
    const task = allTasks.find(t => t.taskId === taskId);
    if (!task) return;
    let userFullName = currentUser?.name || `${currentUser?.firstName || ""} ${currentUser?.lastName || ""}`.trim();
    const announcementsCol = collection(db, 'announcements');
    const now = new Date();
    const announcementData = {
        author: "System",
        authorRole: "System",
        title: `Task Completed: ${task.title}`,
        priority: task.priority || "medium",
        createdAt: now.toISOString(),
        content: `${userFullName} has completed the task "${task.title}". Thank you for your support and dedication! Keep up the amazing work.`
    };
    try {
        await addDoc(announcementsCol, announcementData);
        // UI: Hide submit, show completed button again disabled
        const submitBtn = document.getElementById(`submit-btn-${taskId}`);
        if (submitBtn) submitBtn.style.display = "none";
        // Show disabled Completed button again
        const container = submitBtn?.parentElement;
        if (container) {
            container.innerHTML += `<button class="bg-gray-400 text-white px-4 py-2 rounded-md text-sm font-medium cursor-not-allowed" disabled>Completed</button>`;
        }
    } catch (err) {
        alert("Could not submit completion announcement. Try again!");
    }
};

document.addEventListener('DOMContentLoaded', function() {
    updateTabUnderline();
});
    </script>
</body>
</html>