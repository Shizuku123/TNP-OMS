<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Volunteer - Tahanan ng Pagmamahal OMS</title>
    <script type="module" src="firebase.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'red-primary': '#dc2626',
                        'red-secondary': '#ef4444',
                        'red-light': '#fef2f2'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="index.html" class="flex items-center text-gray-600 hover:text-red-primary transition-colors">
                    <svg class="h-6 w-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <h1 class="text-xl sm:text-2xl font-semibold text-gray-900 text-center flex-1">Add New Volunteer</h1>
                <div class="hidden sm:flex items-center opacity-0">
                    <svg class="h-6 w-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Success/Error Messages -->
        <div id="messageContainer" class="mb-4 hidden"></div>

        <form id="volunteerForm" class="space-y-6 sm:space-y-8">
            <!-- Photo Upload -->
            <div class="bg-white shadow rounded-lg p-4 sm:p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-6">Photo</h2>
                <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-6">
                    <div class="shrink-0">
                        <img id="photoPreview" class="h-24 w-24 sm:h-32 sm:w-32 object-cover rounded-full" src="user.png" alt="Photo preview">
                    </div>
                    <div class="flex-1 w-full">
                        <label for="photo" class="block text-sm font-medium text-gray-700 mb-2">Upload Photo</label>
                        <input type="file" id="photo" name="photo" accept="image/*"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary">
                        <p class="mt-2 text-sm text-gray-500">JPG, PNG or GIF up to 2MB</p>
                    </div>
                </div>
            </div>

            <!-- Personal Information -->
            <div class="bg-white shadow rounded-lg p-4 sm:p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-6">Personal Information</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                    <div>
                        <label for="firstName" class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                        <input type="text" id="firstName" name="firstName" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary">
                    </div>
                    <div>
                        <label for="middleName" class="block text-sm font-medium text-gray-700 mb-2">Middle Name</label>
                        <input type="text" id="middleName" name="middleName"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary">
                    </div>
                    <div>
                        <label for="lastName" class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                        <input type="text" id="lastName" name="lastName" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Gender *</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="gender" value="Male" required class="text-red-primary focus:ring-red-primary">
                                <span class="ml-2">Male</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="gender" value="Female" required class="text-red-primary focus:ring-red-primary">
                                <span class="ml-2">Female</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label for="dateOfBirth" class="block text-sm font-medium text-gray-700 mb-2">Date of Birth *</label>
                        <input type="date" id="dateOfBirth" name="dateOfBirth" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary">
                    </div>
                    <div>
                        <label for="placeOfBirth" class="block text-sm font-medium text-gray-700 mb-2">Place of Birth</label>
                        <input type="text" id="placeOfBirth" name="placeOfBirth" placeholder="Municipality, City, Province"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary">
                    </div>
                    <div>
                        <label for="nationality" class="block text-sm font-medium text-gray-700 mb-2">Nationality</label>
                        <input type="text" id="nationality" name="nationality" value="Filipino"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary">
                    </div>
                    <div>
                        <label for="religion" class="block text-sm font-medium text-gray-700 mb-2">Religion</label>
                        <input type="text" id="religion" name="religion"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary">
                    </div>
                    <div>
                        <label for="civilStatus" class="block text-sm font-medium text-gray-700 mb-2">Civil Status</label>
                        <select id="civilStatus" name="civilStatus"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary">
                            <option value="">Select status</option>
                            <option value="Single">Single</option>
                            <option value="Married">Married</option>
                            <option value="Separated">Separated</option>
                            <option value="Divorced">Divorced</option>
                            <option value="Widowed">Widowed</option>
                        </select>
                    </div>
                    <div class="sm:col-span-2 lg:col-span-3">
                        <label for="currentAddress" class="block text-sm font-medium text-gray-700 mb-2">Current Address *</label>
                        <textarea id="currentAddress" name="currentAddress" rows="3" required
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary"></textarea>
                    </div>
                    <div>
                        <label for="contactNumber" class="block text-sm font-medium text-gray-700 mb-2">Contact Number *</label>
                        <input type="tel" id="contactNumber" name="contactNumber" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary">
                    </div>
                    <div>
                        <label for="emailAddress" class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                        <input type="email" id="emailAddress" name="emailAddress" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary">
                    </div>
                </div>
            </div>

            <!-- Volunteer Information -->
            <div class="bg-white shadow rounded-lg p-4 sm:p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-6">Volunteer Information</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                    <div>
                        <label for="preferredDepartment" class="block text-sm font-medium text-gray-700 mb-2">Preferred Department</label>
                        <select id="preferredDepartment" name="preferredDepartment"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary">
                            <option value="">Select department</option>
                            <option value="Child Care">Child Care</option>
                            <option value="Education">Education</option>
                            <option value="Activities">Activities</option>
                            <option value="Kitchen">Kitchen</option>
                            <option value="Administration">Administration</option>
                            <option value="Events">Events</option>
                            <option value="Counseling">Counseling</option>
                        </select>
                    </div>
                    <div>
                        <label for="skillsAndExperience" class="block text-sm font-medium text-gray-700 mb-2">Skills and Experience</label>
                        <input type="text" id="skillsAndExperience" name="skillsAndExperience"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary">
                    </div>
                    <div>
                        <label for="volunteerStatus" class="block text-sm font-medium text-gray-700 mb-2">Volunteer Status</label>
                        <select id="volunteerStatus" name="volunteerStatus"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                            <option value="On Leave">On Leave</option>
                        </select>
                    </div>
                    <div class="sm:col-span-2 lg:col-span-3">
                        <label for="motivationForVolunteering" class="block text-sm font-medium text-gray-700 mb-2">Motivation for Volunteering</label>
                        <textarea id="motivationForVolunteering" name="motivationForVolunteering" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary"></textarea>
                    </div>
                </div>
            </div>

            <!-- Emergency Contact -->
            <div class="bg-white shadow rounded-lg p-4 sm:p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-6">Emergency Contact</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                    <div>
                        <label for="emergencyContactName" class="block text-sm font-medium text-gray-700 mb-2">Emergency Contact Name</label>
                        <input type="text" id="emergencyContactName" name="emergencyContactName"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary">
                    </div>
                    <div>
                        <label for="emergencyContactRelationship" class="block text-sm font-medium text-gray-700 mb-2">Relationship</label>
                        <input type="text" id="emergencyContactRelationship" name="emergencyContactRelationship"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary">
                    </div>
                    <div>
                        <label for="emergencyContactNumber" class="block text-sm font-medium text-gray-700 mb-2">Emergency Contact Number</label>
                        <input type="tel" id="emergencyContactNumber" name="emergencyContactNumber"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary">
                    </div>
                </div>
            </div>

            <!-- Availability -->
            <div class="bg-white shadow rounded-lg p-4 sm:p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-6">Availability</h2>
                <div class="space-y-4">
                    <p class="text-sm text-gray-600">Select the days you are available to volunteer:</p>
                    <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-4">
                        <label class="flex items-center">
                            <input type="checkbox" name="availability[]" value="Monday" class="text-red-primary focus:ring-red-primary">
                            <span class="ml-2">Monday</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="availability[]" value="Tuesday" class="text-red-primary focus:ring-red-primary">
                            <span class="ml-2">Tuesday</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="availability[]" value="Wednesday" class="text-red-primary focus:ring-red-primary">
                            <span class="ml-2">Wednesday</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="availability[]" value="Thursday" class="text-red-primary focus:ring-red-primary">
                            <span class="ml-2">Thursday</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="availability[]" value="Friday" class="text-red-primary focus:ring-red-primary">
                            <span class="ml-2">Friday</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="availability[]" value="Saturday" class="text-red-primary focus:ring-red-primary">
                            <span class="ml-2">Saturday</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="availability[]" value="Sunday" class="text-red-primary focus:ring-red-primary">
                            <span class="ml-2">Sunday</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Account Creation (Optional) -->
            <div class="bg-white shadow rounded-lg p-4 sm:p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-6">Account Creation (Optional)</h2>
                <div class="flex items-center mb-4">
                    <span class="mr-2 text-sm text-gray-700">Create system account</span>
                    <button type="button" id="createAccountToggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 transition-colors focus:outline-none" aria-checked="false" role="switch">
                        <span id="toggleIndicator" class="inline-block h-5 w-5 transform rounded-full bg-white shadow transition-transform"></span>
                    </button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="username" name="username"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-red-primary focus:border-red-primary">
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4">
                <a href="volunteer-records.html" class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors text-center">
                    Cancel
                </a>
                <button type="submit" class="px-6 py-2 bg-red-primary text-white rounded-md hover:bg-red-700 transition-colors">
                    Add Volunteer Record
                </button>
            </div>
        </form>
    </div>

    <script type="module">
import {
    db,
    collection,
    getDocs,
    setDoc,
    doc,
    auth
} from './firebase.js';
import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

let createAccountEnabled = false;

// Generate unique volunteer ID by checking Firestore
async function generateVolunteerId() {
    const usersCol = collection(db, 'users');
    const snapshot = await getDocs(usersCol);
    let lastId = 0;
    snapshot.forEach(docSnap => {
        const user = docSnap.data();
        if (user.volunteerId && /^VL\d+$/.test(user.volunteerId)) {
            const num = parseInt(user.volunteerId.replace('VL', ''), 10);
            if (num > lastId) lastId = num;
        }
    });
    return `VL${String(lastId + 1).padStart(3, '0')}`;
}

document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
});

function setupEventListeners() {
    // Photo preview functionality
    document.getElementById('photo').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('photoPreview').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    // Account creation toggle
    // You can add a toggle similar to add-staff.html if you want
    // For now, let's assume a toggle with id 'createAccountToggle'
    // Account creation toggle
            document.getElementById('createAccountToggle').addEventListener('click', function() {
                createAccountEnabled = !createAccountEnabled;
                updateAccountToggle();
            });

    // Form submission
    document.getElementById('volunteerForm').addEventListener('submit', handleSubmit);
}



function updateAccountToggle() {
    const toggle = document.getElementById('createAccountToggle');
    const indicator = document.getElementById('toggleIndicator');
    const usernameField = document.getElementById('username');
    if (createAccountEnabled) {
        toggle.classList.remove('bg-gray-200');
        toggle.classList.add('bg-red-primary');
        indicator.classList.remove('translate-x-0');
        indicator.classList.add('translate-x-5');
        toggle.setAttribute('aria-checked', 'true');
        usernameField.required = true;
    } else {
        toggle.classList.remove('bg-red-primary');
        toggle.classList.add('bg-gray-200');
        indicator.classList.remove('translate-x-5');
        indicator.classList.add('translate-x-0');
        toggle.setAttribute('aria-checked', 'false');
        usernameField.required = false;
        usernameField.value = '';
    }
}

async function handleSubmit(e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    const data = {};

    // Collect form data
    for (let [key, value] of formData.entries()) {
        if (key === 'availability[]') {
            if (!data.availability) data.availability = [];
            data.availability.push(value);
        } else if (key !== 'photo') {
            data[key] = value;
        }
    }

    // Convert availability array to comma-separated string
    if (data.availability) {
        data.availability = data.availability.join(', ');
    } else {
        data.availability = '';
    }

    // Add system fields
    data.volunteerId = await generateVolunteerId();
    data.dateAdded = new Date().toISOString().split('T')[0];
    data.createAccount = createAccountEnabled ? '1' : '0';

    // Handle photo base64
    const photoFile = document.getElementById('photo').files[0];
    if (photoFile) {
        data.photoString = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(photoFile);
        });
    } else {
        data.photoString = "";
    }

    await saveVolunteerRecord(data);
}

async function saveVolunteerRecord(data) {
    try {
        // Validate required fields
        const requiredFields = ['firstName', 'lastName', 'gender', 'dateOfBirth', 'currentAddress', 'contactNumber', 'emailAddress'];
        if (createAccountEnabled) {
            requiredFields.push('username');
        }
        for (const field of requiredFields) {
            if (!data[field]) {
                showMessage(`Please fill in the ${field.replace(/([A-Z])/g, ' $1').toLowerCase()} field.`, 'error');
                return;
            }
        }

        let userId = crypto.randomUUID();

        // If account creation is enabled, create user in Firebase Auth
        if (createAccountEnabled) {
            // Format password: TNPOMS@BirthdateDDMMYYYY
            const dob = data.dateOfBirth; // YYYY-MM-DD
            const [yyyy, mm, dd] = dob.split('-');
            const password = `TNPOMS@${dd}${mm}${yyyy}`;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, data.emailAddress, password);
                userId = userCredential.user.uid;
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    showMessage('Email address is already in use.', 'error');
                } else {
                    showMessage('Error creating user account: ' + error.message, 'error');
                }
                return;
            }
        }

        // Prepare Firestore document fields
        const volunteerDoc = {
            uid: userId,
            volunteerId: data.volunteerId,
            firstName: data.firstName || "",
            middleName: data.middleName || "",
            lastName: data.lastName || "",
            emailAddress: data.emailAddress || "",
            contactNumber: data.contactNumber || "",
            username: data.username || "",
            photoString: data.photoString || "",
            gender: data.gender || "",
            civilStatus: data.civilStatus || "",
            nationality: data.nationality || "",
            religion: data.religion || "",
            placeOfBirth: data.placeOfBirth || "",
            dateOfBirth: data.dateOfBirth || "",
            currentAddress: data.currentAddress || "",
            preferredDepartment: data.preferredDepartment || "",
            skillsAndExperience: data.skillsAndExperience || "",
            volunteerStatus: data.volunteerStatus || "",
            motivationForVolunteering: data.motivationForVolunteering || "",
            emergencyContactName: data.emergencyContactName || "",
            emergencyContactRelationship: data.emergencyContactRelationship || "",
            emergencyContactNumber: data.emergencyContactNumber || "",
            availability: data.availability || "",
            createAccount: data.createAccount || "0",
            dateAdded: data.dateAdded || "",
            role: "volunteer",
            isActive: true,
            isBlocked: false,
            otp: "",
            isVerified: false,
            firstTimeLogin: true
        };

        // Save to Firestore: users/{userId}
        const userRef = doc(collection(db, 'users'), userId);
        await setDoc(userRef, volunteerDoc);

        showMessage(`Volunteer record${createAccountEnabled ? " and account" : ""} created successfully!`, 'success');
        document.getElementById('volunteerForm').reset();
        document.getElementById('photoPreview').src = 'user.png';
        document.getElementById('nationality').value = 'Filipino';
        createAccountEnabled = false;
        if (document.getElementById('createAccountToggle')) updateAccountToggle();

        setTimeout(() => {
            window.location.href = 'volunteer-records.html';
        }, 2000);

    } catch (error) {
        console.error('Error saving volunteer record:', error);
        showMessage('Error saving volunteer record. Please try again.', 'error');
    }
}

function showMessage(message, type) {
    const messageContainer = document.getElementById('messageContainer');
    const bgColor = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700';

    messageContainer.innerHTML = `<div class="${bgColor} border px-4 py-3 rounded">${message}</div>`;
    messageContainer.classList.remove('hidden');

    setTimeout(() => {
        messageContainer.classList.add('hidden');
    }, 5000);
}
</script>
</body>
</html>
