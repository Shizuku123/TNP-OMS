<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Details - Tahanan ng Pagmamahal OMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="firebase.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'red-primary': '#dc2626',
                        'red-secondary': '#ef4444',
                        'red-light': '#fef2f2'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center min-w-0 flex-1">
                    <a href="staff-records.html" class="flex items-center text-gray-600 hover:text-red-primary transition-colors">
                        <svg class="h-5 w-5 sm:h-6 sm:w-6 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        <span class="hidden sm:inline">Back to Records</span>
                        <span class="sm:hidden">Back</span>
                    </a>
                </div>
                <h1 id="pageTitle" class="text-lg sm:text-xl font-semibold text-gray-900 text-center flex-1 min-w-0 truncate px-4">Staff Details</h1>
                <div class="flex space-x-1 sm:space-x-2 flex-shrink-0">
                    <button id="editBtn" class="px-2 sm:px-4 py-2 bg-blue-600 text-white text-xs sm:text-sm rounded-lg hover:bg-blue-700 transition-colors">
                        <span class="hidden sm:inline">Edit</span>
                        <svg class="h-4 w-4 sm:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>
    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-4 sm:py-6 px-4 sm:px-6 lg:px-8">
        <div id="staffHeader" class="bg-white rounded-lg shadow mb-4 sm:mb-6 p-4 sm:p-6"></div>
        <div class="bg-white rounded-lg shadow">
            <div class="p-4 sm:p-6">
                <div id="basicInfoContent"></div>
                <!-- Features Granted Section will be inserted here -->
                <div id="featuresGrantedSection" class="mt-10"></div>
            </div>
        </div>
    </div>
    <script type="module">
        import { db, collection, getDocs } from './firebase.js';
        let currentStaff = null;
        let currentStaffId = null;
        let currentUser = null;
        function getCurrentUser() {
            const user = localStorage.getItem('currentUser');
            return user ? JSON.parse(user) : null;
        }
        function requireLogin() {
            if (!localStorage.getItem('currentUser')) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }
        function getStaffIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }
        document.addEventListener('DOMContentLoaded', async function() {
            if (!requireLogin()) return;
            currentUser = getCurrentUser();
            currentStaffId = getStaffIdFromURL();
            if (!currentStaffId) {
                window.location.href = 'staff-records.html';
                return;
            }
            await loadStaffData();
            setupEventListeners();
        });
        async function loadStaffData() {
            try {
                const usersCol = collection(db, 'users');
                const snapshot = await getDocs(usersCol);
                currentStaff = null;
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    if ((data.staffId === currentStaffId || data.uid === currentStaffId) && data.role === 'staff') {
                        currentStaff = data;
                        currentStaff.photoData = data.photoString || 'user.png';
                    }
                });
                if (!currentStaff) {
                    alert('Staff record not found');
                    window.location.href = 'staff-records.html';
                    return;
                }
                displayStaffHeader();
                displayBasicInfo();
                displayFeaturesGranted();
            } catch (error) {
                console.error('Error loading staff data:', error);
                alert('Error loading staff data');
                window.location.href = 'staff-records.html';
            }
        }
        function formatUid(uid) {
            if (!uid) return '';
            if (uid.length <= 10) return uid;
            return uid.substring(0, 4) + '...' + uid.substring(uid.length - 4);
        }
        function displayStaffHeader() {
            const fullName = `${currentStaff.firstName || ''} ${currentStaff.middleName || ''} ${currentStaff.lastName || ''}`.trim();
            const photoSrc = currentStaff.photoData;
            let statusColor = getStatusColor(currentStaff.employmentStatus);
            let statusText = currentStaff.employmentStatus || 'No Status';
            document.getElementById('staffHeader').innerHTML = `
                <div class="flex flex-col lg:flex-row space-y-4 lg:space-y-0 lg:space-x-6">
                    <div class="flex-shrink-0 flex justify-center lg:justify-start">
                        <img src="${photoSrc}" alt="${fullName}" class="h-24 w-24 sm:h-32 sm:w-32 rounded-lg object-cover">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between space-y-4 lg:space-y-0">
                            <div class="min-w-0 flex-1">
                                <h2 class="text-xl sm:text-2xl font-bold text-gray-900 break-words">${fullName}</h2>
                                <p class="text-gray-600 text-sm sm:text-base">Staff ID: ${(currentStaff.staffId || currentStaff.uid) || ''}</p>
                                <p class="text-gray-600 text-sm sm:text-base">Gender: ${currentStaff.gender || 'Not specified'}</p>
                            </div>
                            <div class="flex-shrink-0">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs sm:text-sm font-medium ${statusColor}">
                                    ${statusText}
                                </span>
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                            <div>
                                <span class="font-medium text-gray-900">Date of Birth:</span>
                                <p class="text-gray-600 break-words">${formatDate(currentStaff.dateOfBirth)}</p>
                            </div>
                            <div>
                                <span class="font-medium text-gray-900">Date Hired:</span>
                                <p class="text-gray-600 break-words">${formatDate(currentStaff.dateHired)}</p>
                            </div>
                            <div>
                                <span class="font-medium text-gray-900">Department:</span>
                                <p class="text-gray-600">${currentStaff.department || 'Not specified'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        function displayBasicInfo() {
            document.getElementById('basicInfoContent').innerHTML = `
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 lg:gap-8">
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 mb-4">Personal Information</h4>
                        <div class="space-y-3">
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4">
                                <span class="text-sm font-medium text-gray-500">Full Name:</span>
                                <span class="sm:col-span-2 text-sm text-gray-900 break-words">${currentStaff.firstName || ''} ${currentStaff.middleName || ''} ${currentStaff.lastName || ''}</span>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4">
                                <span class="text-sm font-medium text-gray-500">Gender:</span>
                                <span class="sm:col-span-2 text-sm text-gray-900">${currentStaff.gender || 'Not specified'}</span>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4">
                                <span class="text-sm font-medium text-gray-500">Date of Birth:</span>
                                <span class="sm:col-span-2 text-sm text-gray-900">${formatDate(currentStaff.dateOfBirth)}</span>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4">
                                <span class="text-sm font-medium text-gray-500">Place of Birth:</span>
                                <span class="sm:col-span-2 text-sm text-gray-900 break-words">${currentStaff.placeOfBirth || 'Not specified'}</span>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4">
                                <span class="text-sm font-medium text-gray-500">Nationality:</span>
                                <span class="sm:col-span-2 text-sm text-gray-900">${currentStaff.nationality || 'Not specified'}</span>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4">
                                <span class="text-sm font-medium text-gray-500">Religion:</span>
                                <span class="sm:col-span-2 text-sm text-gray-900">${currentStaff.religion || 'Not specified'}</span>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4">
                                <span class="text-sm font-medium text-gray-500">Civil Status:</span>
                                <span class="sm:col-span-2 text-sm text-gray-900">${currentStaff.civilStatus || 'Not specified'}</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 mb-4">Employment Information</h4>
                        <div class="space-y-3">
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4">
                                <span class="text-sm font-medium text-gray-500">Position:</span>
                                <span class="sm:col-span-2 text-sm text-gray-900">${currentStaff.position || 'Not specified'}</span>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4">
                                <span class="text-sm font-medium text-gray-500">Department:</span>
                                <span class="sm:col-span-2 text-sm text-gray-900">${currentStaff.department || 'Not specified'}</span>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4">
                                <span class="text-sm font-medium text-gray-500">Employment Status:</span>
                                <span class="sm:col-span-2 text-sm text-gray-900">${currentStaff.employmentStatus || 'Not specified'}</span>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4">
                                <span class="text-sm font-medium text-gray-500">Date Hired:</span>
                                <span class="sm:col-span-2 text-sm text-gray-900">${formatDate(currentStaff.dateHired)}</span>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4">
                                <span class="text-sm font-medium text-gray-500">Schedule:</span>
                                <span class="sm:col-span-2 text-sm text-gray-900">${currentStaff.assignedSchedule || 'Not specified'}</span>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4">
                                <span class="text-sm font-medium text-gray-500">Supervisor:</span>
                                <span class="sm:col-span-2 text-sm text-gray-900">${currentStaff.supervisor || 'Not specified'}</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 mb-4">Contact Information</h4>
                        <div class="space-y-3">
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4">
                                <span class="text-sm font-medium text-gray-500">Address:</span>
                                <span class="sm:col-span-2 text-sm text-gray-900 break-words">${currentStaff.currentAddress || 'Not specified'}</span>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4">
                                <span class="text-sm font-medium text-gray-500">Contact Number:</span>
                                <span class="sm:col-span-2 text-sm text-gray-900">${currentStaff.contactNumber || 'Not specified'}</span>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4">
                                <span class="text-sm font-medium text-gray-500">Email:</span>
                                <span class="sm:col-span-2 text-sm text-gray-900">${currentStaff.emailAddress || 'Not specified'}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 pt-6 border-t">
                    <p class="text-xs text-gray-400">Record added on ${formatDate(currentStaff.dateAdded)}</p>
                </div>
            `;
        }

        function displayFeaturesGranted() {
            const featureList = currentStaff.featureGranted || [];
            const grouped = {
                "Recording Sections": [
                    "Add New Child",
                    "Add New Staff",
                    "Add New Volunteer",
                    "Record Donation"
                ],
                "Record Viewing": [
                    "Child Records",
                    "Staff Records",
                    "Volunteer Records",
                    "Donation Records",
                    "Donors Records",
                    "Inventory Records",
                    "Expenses Records",
                    "Discharged Children Records",
                    "Archive Records",
                    "Staff Attendance"
                ]
            };

            let html = `
                <div class="bg-white rounded-lg shadow mt-8 p-4 sm:p-6">
                    <h2 class="text-lg font-medium text-gray-900 mb-6">Features Granted</h2>
                    <div class="mb-6">
                        <h3 class="font-semibold text-gray-700 mb-2">Recording Sections</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                            ${grouped["Recording Sections"].map(f => {
                                const granted = featureList.includes(f);
                                return `<span class="flex items-center space-x-2">
                                    <span class="${granted ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'} px-2 py-1 rounded text-xs font-semibold">
                                        ${granted ? '✔' : '✖'}
                                    </span>
                                    <span>${f}</span>
                                </span>`;
                            }).join('')}
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-2">Record Viewing</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                            ${grouped["Record Viewing"].map(f => {
                                const granted = featureList.includes(f);
                                return `<span class="flex items-center space-x-2">
                                    <span class="${granted ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'} px-2 py-1 rounded text-xs font-semibold">
                                        ${granted ? '✔' : '✖'}
                                    </span>
                                    <span>${f}</span>
                                </span>`;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('featuresGrantedSection').innerHTML = html;
        }

        function formatDate(dateString) {
            if (!dateString) return 'Not specified';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
        function getStatusColor(status) {
            switch (status) {
                case 'Regular':
                    return 'bg-green-100 text-green-800';
                case 'Contractual':
                    return 'bg-blue-100 text-blue-800';
                case 'Part-time':
                    return 'bg-yellow-100 text-yellow-800';
                case 'Probationary':
                    return 'bg-purple-100 text-purple-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }
        function setupEventListeners() {
            document.getElementById('editBtn').addEventListener('click', function() {
                window.location.href = `edit-staff.html?id=${currentStaff.staffId || currentStaff.uid}`;
            });
        }
    </script>
</body>
</html>